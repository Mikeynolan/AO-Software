#!/usr/bin/perl -w

use Getopt::Std;
use Cwd;
$Getopt::Std::STANDARD_HELP_VERSION = 1;

our ($opt_h,$opt_n);

getopts("nh");

#@mdays = (0, 31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31);
#This may give multiple lines. No good way to decide, so just choose the
# last matching one
#

if ($opt_h) { HELP_MESSAGE(); exit;}

sub HELP_MESSAGE {
  print <<'EOF';
Usage: runwrite [-n] logfile
          Runs idl code to generate csv versions of the scans in  a (CW) rdf file, then runs
              cwlabel to make the xml pds labels
          logfile: the "log_output" file generated by the most modern versions of chris_craft
       -n to generate the idl script but not run it or make the labels
EOF
}
     
my $datafile ="";

$logfile = $ARGV[0];

open ($lfh, "<$logfile") or die;

while (<$lfh>) {
  if (/Data file is:\s+(datafile\S+)/) {
    $df = $1;
  }
  if (/Ephemeris file is:\s+(\S+)/) {
    $ephmfile = $1;
  }
  if (/(\S+\.hdr)/) {
    $hdrfile=$1;
    ($obj,$pdate,$res) = ($hdrfile =~ /(\S+?)\.(\S+?)\.(\S+?).cw/);
  }
}

die "No datafile found in logfiles\n" unless defined($df);

#Generate writefile

$rdffile = "$obj.$pdate.$res.rdf";
$pdsfile = "$obj.$pdate.$res";
@prettyfile = glob ("$obj.$pdate.*.cw.ps");
$prettyfile = $prettyfile[0];
if (0 != $#prettyfile) {
  print "More than one prettyfile, choosing $prettyfile\n"
}

open ($scrf, ">", "pdsscript.pro") || die;

print $scrf <<EOF;
\@cwinit
.r /home/nolan/idl/writepds
resetstack
readrdf, '$rdffile'
setpds, pname='${obj}_${pdate}_doppler_spectra'
setpds, editor='Nolan, M.C.'
pointing, data='$df', /noplot, /out, /stack
nst = getnstack()
for i = 1, nst do begin &\$
  addextra, 's', 'ephemeris', '$ephmfile', stack=i &\$
  addextra, 's', 'rawdata', '$df', stack=i &\$
endfor
writestackpds, '$pdsfile', /over
EOF
close $scrf;

`idl86 < pdsscript.pro`;
`cwlabel *.csv`;
if (-e $prettyfile) {
  `pdf2pdfa $prettyfile`;
  $newprettyfile = $prettyfile;
  $newprettyfile =~ s/.ps.pdfa.//;
  rename $prettyfile  $newprettyfile || die "error in renaming";
   `prettylabel $newprettyfile`;
} else {
  print "No cwsumpretty";
}

